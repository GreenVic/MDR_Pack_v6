# Пример работы DMA с UART на передачу и прием данных.

DMA работает в основном режиме, используются только основные структуры каналов. Пример полностью аналогичен примеру DMA_SPI, только обмен происходит по UART.

   TX - Один канал DMA настроен на обработку запросов от UART по наличию пустого места в FIFO передатчика.
   RX - Еще один канал DMA настроен на обработку запросов от UART по наличию данных в FIFO приемника.

По нажатию на кнопку Up (Key1) запускается цикл передачи данных:
   - Загораются два светодиода (LED_CYCLIC, LED_ERR), показывая начало цикла DMA.
   - Канал DMA_TX копирует данные из массива в регистр DR передатчика UART, по мере появления пустого места в FIFO передатчика.
   - Передатчик передает данные по линии, которые получает приемник UART в свой регистр DR.
   - UART по приему слова выставляет запрос к DMA_RX, который копирует данные в массив принятых данных.
   - Данные сравниваются. Если данные не совпали, то второй светодиод (LED_ERR) остается включенным, показывая ошибку. Если данные совпали то LED_ERR выключается. Светодиод LED_CYCLIC вне обработчика кнопки UP постоянно мигает, показывая что исполнение не зависло в обработчике прерывания DMA.

На демоплате необходимо замкнуть контакты UART_TX и UART_RX, какие это именно контакты необходимо посмотреть по назначению пинов в структурах UART_TX_Pins и UART_RX_Pins. (Для 1986ВК234 это PB0-PC1.) Если сигналы не подключать, то светодиод LED_ERR остается гореть, показывая что передачи не было.

Пример работает как при включенном FIFO блока UART, так и при выключенном - это можно поменять в параметре .cfgBase.useFIFO = MDR_Off, структуры CfgUART.

## Особенности для 1986ВЕ8Т, 1923ВК014, Электросилы
В 1986ВЕ8Т, 1923ВК014, ЕСиле обнаружено, что в момент присвоения функции пину, UART_RX ловит переключение на этом пине и воспринимает его за слово, при этом защелкивается запрос к DMA и в FIFO_RX появляетя "принятое" слово.

(например GPIO_Port->FUNC1_Set = cfgSet->FUNC_8_15; для _pinRX_UART2_PA10)

Запрос к каналу DMA сбросить нельзя, даже если вычитать FIFO_RX, поэтому когда доходит до инициализации и включения канала DMA, то DMA тут же осуществит передачу принятого слова. Чтобы этого избежать, в данном проекте пин UART_RX настривается до того, как будет настраиваться сам блок UART. При такой последовательности UART включается уже после того как присвоена функция пину, и поэтому он не ловит какой-то бросок напряжения при переключении мультиплексора FUNC и не считает его стартовым битом. Поэтому паразитное слово не читается и запрос к DMA не выставляется.

Примечательно, что пин в момент переключения регистров FUNC находится в аналоговой функции. Предполагалось настроить весь цифровой тракт пина, а потом одной командой выводить пин из аналогового режима в цифровой на уже готовые настройки.

Примечательно так-же, что если скорость UART выставить меньше, наприме в 115200 бод, то блок UART не реагирует описанным образом на переключение FUNC пина RX. Вероятно при маленькой скорости UART не замечает "иголку" на RX и не принимает ее за стартовый бит.

В обычном случае лучше сначала настраивать периферийный блок, а затем подключать к нему пины, чтобы пины включались в определенное состояние, уже заданное блоком. Для остальных МК данной необходимости не замечено.