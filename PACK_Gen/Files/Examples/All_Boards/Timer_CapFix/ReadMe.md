# Пример показывает влияние бита 4 (CAP_Fix) в регистре блока таймеров CHx_CNTRL2.

Бит CAP_Fix - это аппаратное исправление ошибки 0015 из Errata на 1986ВЕ9х. В других контроллерах эта ошибка тоже проявляется, но записей об этом в Errata нет.

Таймер работает на частоте TIM_CLOCK, с которой фиксирует события захвата. В момент когда происходит захват, таймер одновременно выставляет флаг запроса на прерывание и сохраняет значение регистра CNT в регистр захвата CCR, или CCR1 в зависимости от настроек. При выставлении большого делителя BRG, частота ядра становится во много раз больше частоты TIM_CLOCK. Поэтому возникают ситуации когда таймер значение в CCR еще не обновил, а ядро уже обработало вызов прерывания и в обработчике произошло считывание старого значения CCR.

Бит 4 в регистре CHx_CNTRL2 откладывает запрос на прерывание на один такт TIM_CLOCK, чтобы успеть обновить значение в CCR. Тогда при возникновении прерывания не происходит считывания старых значений CCR.

В примере перебираются все значения BRG, которые формируют TIM_CLOCK. При этих значениях один таймер генерирует ШИМ, фронт сигнала которого захватывается первым каналом второго таймера. Еще один канал таймера захватывает события захвата в первом канале. Таким образом в двух каналах таймера происходит синхронный захват фронта от ШИМ. Значение регистров CCR обоих каналов сохраняются в массив и далее происходит проверка на одинаковость значений в обоих каналов. Массивы и результат сравнения выводятся в UART для наблюдения в любой программе, типа Terminal или Putty.

По кнопке Up запускается тест без бита CAP_Fix, по кнопке Right этот же тест, но с битом CAP_Fix. Логи из UART приведены в файле TestLogs.xlsx. По ним видно, что при максимальных делителях BRG возникают описанные сбои при захвате. При наличии CAP_Fix сбоев нет. В некоторых МК бит CAP_Fix не реализован.

##Последствия
Поскольку прерывание откладывается на 1 такт TIM_CLOCK, то например при делителе BRG со значением 128, CPU получит прерывание только через 128 своих тактов после реального захвата. Поэтому в задачах где важно получить прервание по фронту, т.е. совсем не нужно значение CCR, бит CAP_Fix лучше не использовать. Это позволит получить прерывание максимально быстро. С другой стороны в подобных задачах (получения прерывания по фронту) нет смысла ставить большой делитель BRG, поскольку это уже увеличивает шаг с которым событие фронта будет обнаружено. Т.е. случай несколько искусственный.

Если же важно получить значения захвата - тогда необходимо использовать CAP_Fix при больших делителях BRG.

##Результат
  * 1986ВЕ3 (рев 2,3) - нет проблемы вообще
  * 1901ВЦ01 1986ВК234 - бит не реализован
  * 1986ВЕ1Т (рев 4,7), 1986ВЕ4У, 1986ВЕ9х - бит работает.
  * 1986ВК214 - тест не подходит, т.к. в таймерах реализован только один канал.