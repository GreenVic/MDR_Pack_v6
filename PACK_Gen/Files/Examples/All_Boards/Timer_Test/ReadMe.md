# Примеры использования блока Timer

Тесты переключаются по очереди по нажатию на кнопку UP. Результат тестов наблюадется на светоиодах, LCD экране, или если пины экрана заняты на UART.

##  Режим внутреннего счета - Счет импульсов TIM_CLOCK. 

### TI_SimplestFlash
Пример простейшей инициализации таймера для получения прерываний с заданным периодом.
Одновременно мигают три светодиода от трех таймеров считающих синхронно. (Аналог использования системного таймера.)

### TI_CountTimClock
Пример настройки счета таймера с указанием всех настроек через структуру MDR_Timer_CfgCountClock.
Аналог test_SimplesFlash, но с разными направлениями счета. Светодиоды мигают синхронно.

### TI_CascadeTimer
Пример каскадного включения таймеров.
####  ОСОБЕННОСТИ:
TIMER1 считает TIM_CLOCK обычным образом. TIMER2 подключенный каскадно к TIMER1 отрабатывает правильно - период в TIMER2_ARR+1 раза длиннее, события CNT=ARR возникают синхронно и соответственной с разной частотой. НО по неизвестной причине TIMER3 и TIMER4 подключенные каскадно переключаются не по CNT=ARR предыдущего таймера, а с задержкой на один период самого младшего таймера TIMER1. Для TIMER4 задержка на два периода TIMER1.

Периоды удобней смотреть на осциллографе. Для этого на отладочных платах, там где есть, лучше снять джампера со светодиодов и подключиться осцилографом. Период TIMER1 для удобства наблюдения лучше сильно уменьшить, например значениями - TIM_BRG_LED, TIM_PSG_LED.

##  Вывод ШИМ на пины каналов таймeров

НЕОБХОДИМО ПРОВЕРИТЬ, что выходы каналов таймеров не замкнуты друг на друга, после тестов с захватом! Иначе выход будет работать на выход и потекут сквозные токи. Для исключения ошибки, пины таймеров желательно подключать через резистор ограничивающий ток до 1мА. Перед сменой теста провода отключать и подключать под новый вариант.

### TI_Pulse
Пример простейшей генерации импульсов на выходах канала таймера. Требуется минимальное количество параметров, остальные по умолчанию. Импульсы смотреть осциллографом на пинах. (Это тот же ШИМ, но в терминах периода сигнала и коэффициента заполнения (скважности). Полезно там, где необходимо подать импульсы одной командой, не задумываясь о направлениях счета, прерываниях и прочих настройках.)

### TI_PWM
Пример генерации ШИМ по умолчанию - без задания опциональных настроек, MDR_TimerCh_CfgPWM = NULL. Импульсы смотреть осциллографом на пинах. 

### TI_PWM_DTG
Пример генерации ШИМ c задержкой между фронтами прямого и инверсного каналов - Dead Time Generator (DTG).  Смотреть осциллографом на каналах Timer1:
  * Сигнал с DTG выводится на CH1 и nCH1.
  * Сигнал без DTG выводится на CH2 и nCH2 (кроме 1986ВК214, там в таймере только один канал).
Настройки задаются через не NULL структуру MDR_TimerCh_CfgPWM.

### TI_PWM_ClearBRKETR
При запуске теста на выводы Timer1 CH1 и CH2 выводятся два разных сигнала.
Выводы BRK и ETR настроены на выключение импульсов - сигнал ШИМ падает в 0.
Вход BRK выключает пульсации на CH1 - при BRK=Ucc импульсы идут, при BRK=GND нет.
Вход ETR выключает пульсации на CH2 - при ETR=GND импульсы идут, при BRK=Ucc нет.
Для проверки подключать данные выводы на землю и Ucc соответственно проводами.

(Для 1986ВК214 сбрасывается CH1 и по BRK и по ETR - т.к. в 1986ВК214 только один канал в таймере.)

##  Режимы захвата ( CAPture)

НЕОБХОДИМО внешнее подключение пинов с ШИМ к пинам захвата! Один канал генерит ШИМ, который подается на другой канал (другого таймера) для захвата фронтов.

### TI_CAP_Simplest
Timer1 генерирует импульсы на выходе CH1 и мигает светодиодом LED1 каждый период.
Timer2 захватывает события переднего и заднего фронтов сигнала от Timer1_CH1.
При каждом событии генерируется прерывание и переключается светодиод LED2.
Мигания светодиода LED2 должны получиться в 2 раза чаще чем LED1.

Простейшая настройка захвата с параметрами по умолчанию, MDR_TimerCh_CfgCAP = NULL. Разрешается захват обоих фронтов, переднего и заднего.

### TI_CAP_Period
Timer1 генерирует импульсы на выходе CH1 и мигает светодиодом LED1 каждый период. Timer3 захватывает события переднего и заднего фронтов сигнала от Timer1_CH1. В прерывании по спаду, эти значения сохраняются в массивы до накопления AVER_COUNT измерений. После этого прерывания по захвату отключаются, высчитываются средний период и длительность импульса, результаты выводятся на LCD панель.

При нажатии на кнопку Down повторяется цикл измерений AVER_COUNT с выводом результатов. При нажатии на кнопку Right уменьшается период ШИМ, и повторяется цикл измерений. 

При периоде ШИМ порядка 172 периодов TIM_CLOCK начинает не хватает быстродействия на исполнение обработчика прерывания. При считывании значений фронтов, данные переднего фронта обгоняют данные от заднего. Алгоритм выдает неправильные данные - RMS растет, а период увеличивается вместо уменьшения. Для захвата значений на высоких частотах лучше использовать DMA!

В 1986ВК214 сбой начинается с периодом ШИМ в 248 тактов, результат выводится в UART_Debug. Для наблюдения необходимо подключить переходник от UART через USB к РС. Лог получать в программах типа, Terminal или Putty.


## Режимы внешнего счета
Примеры реализуют подсчет импульсов на входе ETR и событий (фронтов) на каналах захвата.

### TI_PWM_CountETR
Пример счета таймера от внешних импульсов на входе ETR.
Таймер1 генерирует импульсы, которые подаются на вход ETR Таймера2.
В прерываниях таймеров по периоду: 
  * Таймер1 переключается светодиод1, 
  * Таймер2 переключается светодиод2.
В коде можно поменять настройки фильтров, частоты сэмплирования и прочего для изучения их влияния на периоды мигания светодиодов.

В 1986ВК214 без подключения наблюдается беспорядочное мигание светодиода (из-за наводок или утечек). При подключении TIM1_CH1 к TIM2_ETR мигания ожидаемо упорядочиваются.

### TI_PWM_CountCAP
Все тоже самое как в TI_PWM_CountETR, только для счета используются импульсы на входе прямого канала таймера.

Пример подсчета передних фронтов на входе канала таймера. Таймер1 генерирует импульсы c выхода CH1, которые подаются на вход CH1 Таймера2.