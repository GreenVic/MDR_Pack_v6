# Проекты сборки файлов FLM.

Все FLM поддерживают стирание по секторам.

При открытии проектов, отказаться от предложения установить 
"Legacy Support for ARM7, ARM9 & Cortex-R"

"Legacy support for Arm Cortex-M devices" должен быть установлен.

FLM НЕ собираются в демо-версии, ограничение на MDK-Lite.

В директории test лежат тестовые проекты, которые запускаются из ОЗУ и вызывают функции FPL для проверки их работоспособности.


## Особенности для 1986ВЕ4У, 1986ВЕВК214, 1986ВК234
В FLM для 1986ВЕ4У, 1986ВЕВК214, 1986ВК234 при вызове функции EraseAll() проверяется бит FPOR в регистре REG_0E блока BKP. Если бит FPOR равен 0, то в информационную память записывается начальный загрузчик.

Бит FPOR равен нулю при запуске МК после подачи питания. Исполняясь начальный загрузчик выставляет бит FPOR, который не сбрасывается при последующих reset. Таким образом, обычный запуск FLM не приводит к перезаписи начального загрузчика.

Но если начальный загрузчик в информационной памяти будет испорчен, то он не отработает при включении питания и бит FPOR останется равен 0. Вызов стирания Erase в Keil в данной ситуации перезапишет загрузчик когда будет исполняться FLM.


## Особенности для 1986ВЕ1, 1986ВЕ9х
Флеш память имеет ускоритель, в который вычитываются сразу стоки памяти, а не одно то слово к которому идет обращение. Перед запуском FLM в ускорителе уже лежат первые строки данных которые считались при подаче питания. Но после отработки FLM в памяти теперь лежат новые записанные данные, и когда происходит верификация и шина читает данные, то от флеш возвращаются данные не из самой памяти, а из буфера флеша - т.е. старые данные. Поэтому этап верификации проваливается, верификация выдает ошибку на первом же адресе. Чтобы верификация прошла успешно, в функции Init происходит чтение нескольких первых слов. Когда адрес этих первых слов выходит за диапазон данных закешированых в буфере, то буфер обновляется новыми данными. Чтобы обновить буфер в 1986ВЕ1Т достаточно считать 5 слов, при этом ошибка с верификацией исчезает. Для 1986ВЕ9х необходимо считать 9 слов. Строка состоит из 4-х 32-разрядных слов, Отсюда можно сделать вывод что буфер флеш составляет 1 строку, а в 1986ВЕ9х - две строки.

## Особенности для 1986ВЕ81
Для прошивки использован код от Vasili с форума, шьются все биты сразу. Память СОЗУ не требует больших задержкек, поэтому в коде их нет.

## Особенности для 1986ВЕ8
ДАННЫЕ FLM ПРЕДСТАВЛЕНЫ ТОЛЬКО В КАЧЕСТВЕ ПРИМЕРА!!! StartMilandr и авторы FLM не несут ответственности за любые последствия связанные в применением данных FLM! У нас они отработали без ошибок несколько раз, но отработать все варианты их применения нет возможности, поскольку образец только один и набрать статистику нет возможности. Представлено три FLM для разных источников тактирования:
  * HSI - прожиг от внутреннего генератора 8МГц. Позволяет только прожечь, нельзя выполнить верификацию согласно спецификации, т.к. нет возможности реализовать тактирование на 25МГц. Верификация проходит только на частоте, которую дает HSI.
  * HSI1 25MHz - прожиг от внешнего генератора на 25МГц. Полноценная реализация с верификацией.
  * HSE0 10MHz - ТОЛЬКО ДЛЯ 5 РЕВИЗИИ, где исправлена ошибка большого джиттера PLL. 10МГц от внешнего резонатора умножаются в PLL до 100МГц, задем делителями на ядро подается 25МГц, что позволяет осуществить и прожиг и полноценную верификацию.

Прожиг для всех источников прошел с первого раза, без фазы допрограммирования, верификация везде успешна. Прожигался проект с миганием светодиодами в конец памяти ОТР. Запуск проектов происходил из отладчика, который осуществлял запуск с необходимого адреса.

ПАМЯТЬ шьется ДОЛГО! Иникатор прогресса замирает секунда на 15-20, при прошивке каждой страницы. Размер страницы в FLM задан в 0х400 байт, это значение можно менять чтобы шить меньшими порциями. 

По прошивке будет отдельная статья на StartMilandr.ru.


