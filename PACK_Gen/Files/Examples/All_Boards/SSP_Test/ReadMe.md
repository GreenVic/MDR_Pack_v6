# Примеры использования блока SSP

Тесты - это варианты использования, в каждом тесте меняется один параметр и проверяется работоспособность блока.
Изменяемый параметр глобальный - т.е. при переключении в другой тест этот параметр сохраняет значение для нового теста.

Фото подключений SSP1 - SSP2 на отладочных платах представлены здесь - https://startmilandr.ru/doku.php/prog:spi:demoboards_ssp1_ssp2

Для запуска, необходимо выбрать проект под свой микроконтроллер, скомпилировать и загрузить.

КНОПКИ:
  - Up    - смена теста
  - Down  - передача данных и вывод результата.
  - Right - смена изменяемого параметра, в каждом тесте своего.

Тесты:
  - LBM - Тестовый обмен TX->RX внутри одного блока, без использования выводов GPIO. (Работает при максимальной скорости, PSR_2_254 = 2). Right - Смена режима SPI - CPO и CPH.
  - TXRT - Обмен данных в одном блоке SPI, необходимо подключить выводы GPIO TX->RX. (Работает при максимальной скорости, PSR_2_254 = 2). Right - Смена делителя PSR_2_254, по +2. Младший бит делителя не валиден.
  - Master-Slave - Обмен между двумя блоками SPI на одной плате. Right - Смена делителя PSR_2_254, по +2. Младший бит делителя не валиден.
    |Подключение выводов GPIO|||
    |Master_TX  |->| Slave_RX|
    |Master_RX  |->|Slave_TX|
    |Master_CLK |->|Slave_CLK|
    |Master_FSS |->|Slave_FSS|
  - DataBits - Вариант Master-Slave, меняется количество бит в слове. Right - Смена количества бит в слове
  - Frames - Вариант Master-Slave, меняется тип фрейма. Right - Смена фрейма SPI или SSI. При Microwire особый протокол, для которого отдельный тест.
  - Microwire - Вариант Master-Slave, используется режим Microwire. Right - Смена битов в ответном слове от ведомого. Команда от мастера всегда 8-ми битная.
  - IRQ - Вариант Master-Slave, c использованием прерываний и заполнением FIFO. Right - Смена количества бит в слове
  - LBM_ALL - Перебор всех доступных SSP и проверка в режиме LBM (проверка, что функции работают со всеми SSP правильно). Right - смена блока SSP для которого выполняется тест LBM.

Тесты с подключением Master-Slave работают при делителе PSR_2_254 = 12 (В некоторых платах начиная с 14). Делитель не ниже 12-ти необходим для работы Slave, так указано в спецификации.

## Особенности SSP
 - Разрешение прерываний по событиям (в регистре IMSC) приводит в вызову обработчика, если флаг события активен. Даже если блок SSP еще не включен (регистр SR1 = 0)!
 - Режим работы Microwire подразумевает только получение ответа от ведомого. Мастер лишь посылает 8-битную команду и продолжает генерировать клок в количестве ожидаемого количества бит в ответе + 1. На первый бит после посылки команды мастером ведомый выводит ноль (это и есть +1 бит), затем следует сами ответные данные. Подробнее см. графики на картинке Microwire.png.
 - Выбор фронтов SPO SPH возможен только в режиме SPI.
 - В режиме LBM (Loop Back Mode) сигналы на GPIO не выходятся.

## Подключение Jtag (с которым проверялся пример)
  - 1986VE91: JtagA
  - 1986VE92: JtagA
  - 1986VE93: JtagA
  - 1986VC1 : JtagA
  - ESila   : JtagA

В файле MDR_Config.h использовать соответствующий включению USE_JTAG_A/USE_JTAG_B или закомментировать оба! Файл MDR_Config.h копируется Keil при создании проекта в директорию проекта RTE, например \VE93\RTE\Device\MDR1986VE93.

## Особенности запуска на платах.
Расположение джамперов для плат представлено на фотографиях.
  - 1986ВЕ91Т - снять джампера со светодиодов, они конфликтуют с пинами, выбранными для SSP1 - см. MDRB_1986VE91.h
  - 1986ВЕ93У - Снять джампера со светодиодов. В этом МК мало выводов GPIO, поэтому доступен для тестов только SSP1. Мастер-слэйв обмены провести нельзя. Доступны лишь тесты LBM и TX-RX. При выполнении теста TX-RX выводы необходимо подключить через резистор, потому что они оба используются в LCD и являются выходами. Максимальный ток через вывод в спецификации составляет порядка 6мА, обычно же считается что ток в КМОП схемах составляет порядка 1мА. Поэтому лучше выбрать резистор ориентируясь на ток 1мА. В моем подключении использовался резистор на 4,6КОм. Поскольку ограничение тока снижает быстродействие, то обмен заработал при делителе равном 26 (см. фото).
  - "Электросила" - не получилось добиться работоспособности SPI, если его пины совмещены с активным JTAG. Проц попросту виснет, отладчик отваливается. Отладить поведение пока не удалось, возможно проблема в библиотечных функциях с USE_JTAG_..., установить не удалось. (При подключении через JtagA, тест RX-TX проходит успешно для SSP2 - пины в PortB. Если мастером выбрать SSP1, то МК зависает при обмене RX-TX, отладчик отрубается. Т.к. пины и Jtag, и SSP1 находятся в PortА.)
  - 1923ВК014 - вместо кнопок команды подаются через UART. Символ 'N' - следующий тест, 'C' - смена параметра, 'E' - выполнить. Результат так-же выводится в UART. Поясняющие картинки в директории Images.
  
