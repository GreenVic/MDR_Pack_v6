# Пример записи в память SRAM(OTP) в 1986ВЕ81Т.

В примере записывается-считывается некоторое количество данных в память кода SRAM.

## По нажатию KEY1: Запись-чтение
В память SRAM 1986ВЕ81Т, которая вместо ОТР, записывается массив значений. Затем массив считывается и проверяется то, что данные совпали. Этим проверяется что функция записи в память MDR_OTPSRAM_ProgWordWord() работает корректно. Если функция некорректна и память находится в не согласованном с ЕСС состоянии после включения питания, то при обращении к памяти происходит выход в HardFault.

Реализация функций для работы с памятью взята от Vasili с форума - http://forum.milandr.ru/viewtopic.php?p=20531#p20531 За что ему большое СПАСИБО!

## По нажатию KEY2: Демонстрация ошибки
Производится считывание из области памяти ОРТ в которой значения не согласованы с  ЕСС - содержат хаотичные значения возникшие при включении питания. При чтении возникает не одинарная ошибка ЕСС, шине запрещено возвращать ядру некорректные данные, поэтому шина не отвечает и ядро фиксирует ошибку BusFault. Исключение BusFault не активировано, поэтому исключение падает в HardFault, в обработчике которого переключаются все три светодиода. Мигание светодиодов происходит потому, что исполнение после обработчика возвращается на адрес который привел к ошике и исполняет ту-же самую инструкцию. Которая, в свою очередь, снова вызывает исключение HardFault. Обработчик HardFault оказвается зацикленным, исполняется снова и снова. Поэтому в обработчике инкрементируется счетчик, чтобы мигание светодиодов происходило заметно для человека.

## По нажатию KEY3: Парирование ошибки
Чтобы выйти из зацикленного обработчика HardFault необходимо парировать ошибку, т.е. проинициализировать ячейку памяти которая читается в тесте - OPT_TEST_FAULT_ADDR. По нажатию на KEY3 в данную ячейку записывается любое значение, например 0. Для адреса и памяти функция MDR_OTPSRAM_ProgWordWord() значение ECC, которое записывается вместе с данными. Теперь чтение данного адреса не вызывает ошибки ЕСС, поэтому при выходе из HardFault возврат в обработчик не происходит. Зацикливание прервано и исполнение снова в главном цикле. Теперь по KEY2 выход в HardFault уже не происходит!

Чтобы в тесте снова срабатывало HardFault необходимо снять питание и подождать десяток секунд чтобы память сбросилась. Пары секунд на это бывает недостаточно.

## LED:
  * LED_CYCLE - Мигает, показывая что основной цикл исполняется. 
  * LED_OK  - Загорается после нажатия на KEY1, если запись-чтение выполнились успешно.
  * LED_ERR - Загорается после нажатия на KEY1, если запись-чтение выполнились не успешно, данные не совпали.
  * Мигают все LED_CYCLE | LED_OK | LED_ERR - произошел выход в HardFault по кнопке KEY2.