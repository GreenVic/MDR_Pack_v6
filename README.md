# MDR_Pack_v6

Попытка написать пак для компилятора Keil v6 с поддержкой для всех МК от "Миланд".

## Проблема с компилятором ARM Compiler V5.06

Для наглядности кода повсеместно использованы перечисления ENUM и битовые поля. Это позволяет присваивать в битовые поля именованные значения, что удобно для восприятия кода и позволяет получать предупреждения от компилятора, если задано неправильное значение.

Например:

  MDR_CLOCK->HS_CONTROL_b.HSE_ON = 1; //MDR_On;

  warning:  #188-D: enumerated type mixed with another type

Но в тоже время, это создало серьезную проблему. Поскольку ENUM разрешается к минимальному размеру хранения, чаще всего к байту, то при записи в регистры компилятор использует байтовое обращение к регистрам - LDRB, STRB.

Например:

  MDR_CLOCK->HS_CONTROL_b.HSE_ON = MDR_On;

  0x000023B6 4862      LDR      r0,[pc,#392]  ; @0x00002540
  0x000023B8 7A00      LDRB     r0,[r0,#0x08]
  0x000023BA 0840      LSRS     r0,r0,#1
  0x000023BC 0040      LSLS     r0,r0,#1
  0x000023BE 1C40      ADDS     r0,r0,#1
  0x000023C0 495F      LDR      r1,[pc,#380]  ; @0x00002540
  0x000023C2 7208      STRB     r0,[r1,#0x08]

Это плохо, даже ARM рекомендует обращаться к внутренним регистрам ядра только 32-битными обращениями. В случае же с периферийными регистрами ситуация еще хуже. Согласно ассемблерному коду записывается байт 0х01, но видимо регистр HS_CONTROL не работает с байтным обращением. В результате попытки записать в него байт, значение регистра изменяется с 0х0000_0000 на 0х0000_0101. Т.е. в результате записи в него по внутренней шине байта с единицей, на самом деле записывается два байта. Регистр HS_CONTROL имеет мало значащих бит, в случае же с регистрами у которых определены все 32 бита записывается сразу 4-ре байта - 0х0101_0101.

Никакими способами не удалось заставить компилятор формировать словное обращение к регистру. Помогло только лишь выставление опции в настройках компилятора Си - "Enum Containers always int". Теперь компилятор понимает, что значение перечесления (например MDR_On) является словом и формирует правильное, словное обращение к регистру - LDR, STR.

  0x000023B4 4860      LDR      r0,[pc,#384]  ; @0x00002538
  0x000023B6 6880      LDR      r0,[r0,#0x08]
  0x000023B8 0840      LSRS     r0,r0,#1
  0x000023BA 0040      LSLS     r0,r0,#1
  0x000023BC 1C40      ADDS     r0,r0,#1
  0x000023BE 495E      LDR      r1,[pc,#376]  ; @0x00002538
  0x000023C0 6088      STR      r0,[r1,#0x08]

Интересно, что компилятор ARM Compiler V5.06 генерит байтовый доступ при оптимизациях -O0, -O1 (Debug). При прочих оптимизациях обращения используются словные и без галочки "Enum Containers always int".

С компилятором версии ARM Compiler 6 проблем с байтовым обращением к регистрам нет. И поскольку библиотера ориентирована с первую очередь на этот новый компилятор, то принято решение не отказываться от ENUM, а для сборки библиотеки с компилятором версии 5х включать опцию "Enum Containers always int".


## Notes

Функции с префиксом MDR_ выходят из модулей, без префикса остаются в них (Не видны за пределами модуля - static). В название дописал суффикс _loc, чтобы выделялось в коде и было более читаемо (local).